version: '3'

networks:
  default:
    name: cloud_net

service:
  db:
    image: mariadb:10.5
    container_name: cloud_db
    restart: always
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    volumes:
      - ./mariadb/db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=Sinath@19881007..
      - MYSQL_PASSWORD=Sinath@90
      - MYSQL_DATABASE=mycloud
      - MYSQL_USER=yuen
    ports:
      - 3306:3306
    networks:
      - default

  redis:
    image: redis:alpine
    container_name: cloud_redis
    restart: always
    expose:
      - "6379"
    volumes:
      - ./redis/cache:/data
    commard: redis-server --requirepass 'Sinath@90'
    networks:
      - default

  app:
    image: nextcloud:24.0.3-fpm-alpine
    restart: always
    ports:
      - 80:80
    volumes:
      - ./cloud/data:/var/www/html
    environment:
      - NEXTCLOUD_ADMIN_USER=YuiKuen.Yuen
      - NEXTCLOUD_ADMIN_PASSWORD=Sinath@19881007..
      - NEXTCLOUD_TRUSTED_DOMAINS='cloud.yuikuen.top'
      - REDIS_HOST=redis
      - REDIS_HOST_PORT=6379
      - REDIS_HOST_PASSWORD=Sinath@90
      - TZ=Aisa/Shanghai
      - MYSQL_DATABASE=mycloud
      - MYSQL_USER=yuen
      - MYSQL_PASSWORD=Sinath@90
      - MYSQL_ROOT_PASSWORD=Sinath@19881007..
      - MYSQL_HOST=db
      - UID=0
      - GID=0
      - UPLOAD_MAX_SIZE=10G
      - APC_SHM_SIZE=1024M
      - OPCACHE_MEM_SIZE=512
      - CRON_PERIOD=15m
    depends_on:
      - db
      - redis
    links:
      - db
    cap_add:
      - MKNOD
    networks:
      - default
  
  proxy:
    image: nginxproxy/nginx-proxy:alpine
    container_name: cloud_proxy
    restart: always
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./nginx/certs:/etc/nginx/certs:ro
      - ./nginx/vhost.d:/etc/nginx/vhost.d
      - ./nginx/html:/usr/share/nginx/html
      - ./nginx/conf.d:/etc/nginx/conf.d
      - /var/run/docker.sock:/tmp/docker.sock:ro
    networks:
      - default

  collabora:
    image: collabora/code:22.05.5.1.1
    container_name: cloud_collabora
    restart: always
    environment:
      - domain=office.yuikuen.top
      - username=yuikuen
      - password=Sinath@90
      - dictionaries=de en es zh
    cap_add:
      - MKNOD
    ports:
      - 9980:9980
    volumes:
      - ./collabora/coolwsd.xml:/etc/coolwsd/coolwsd.xml
    networks:
      - default

    



